#!/usr/bin/env node

const fs = require("mz/fs");
const assert = require("assert");
const webdriver = require("selenium-webdriver");
const By = webdriver.By;
const until = webdriver.until;
const ChromeExtension = require("./scripts/ChromeExtension");
const WebDriver = require("./scripts/WebDriver");

(async () => {
    try {
        if (!process.env.TEST_TWITTER_USERNAME || !process.env.TEST_TWITTER_PASSWORD) {
            throw new Error("Username or password must be specified.");
        }

        // Initialize
        const test = new WebDriver(await fs.realpath("src"), 30000);
        await test.initialize();

        await test.driver.get("https://tweetdeck.twitter.com");
        await test.driver.wait(until.titleIs("TweetDeck"));
        console.log("Test: Loaded the components.");

        // Login button
        const login = await test.driver.findElement(By.css("form.form-login a.btn"));
        await login.click();

        // Login form
        const form = await test.driver.wait(until.elementLocated(By.css("form.signin")), test.timeout);

        // Input username
        const username = await form.findElement(By.name("session[username_or_email]"));
        await username.sendKeys(process.env.TEST_TWITTER_USERNAME);

        // Input password
        const password = await form.findElement(By.name("session[password]"));
        await password.sendKeys(process.env.TEST_TWITTER_PASSWORD);

        // Execute login
        await form.submit();
        console.log("Test: Logged into TweetDeck.");

        // TweetDeck
        await test.driver.wait(until.elementLocated(By.css(".js-show-drawer")));
        const main = await test.driver.findElement(By.css(".application"));

        // Since the app is loaded, shorten timeout value.
        await test.driver.manage().setTimeouts({
            implicit: 0,
        });
        console.log("Test: Application is loaded.");

        for (let i = 0; i < 5; i++) {
            console.log(`Test: New Tweet (${i + 1}/5)`);

            // New Tweet button
            const button = await test.driver.findElement(By.css(".js-show-drawer.btn-compose"));
            await button.click();

            // Wait until the buttons become available
            await test.driver.wait(until.elementLocated(By.css(".js-send-button")), test.timeout);

            for (let j = 0; j < 50; j++) {
                const accounts = await main.findElements(By.css(".js-account-list .js-account-item"));
                const target = accounts[Math.floor(Math.random() * accounts.length)];
                const key = await target.getAttribute("data-account-key");
                const item = await test.driver.findElement(By.css(`.js-account-item[data-account-key="${key}"]`));
                await item.click();

                const current = await main.findElements(By.css(".js-account-list .js-account-item.is-selected"));
                assert(current.length <= 1);
            }

            // Close Tweet drawer
            const closer = await test.driver.findElement(By.css(".js-drawer-close"));
            await closer.click();
        }

        // Reopen Tweet drawer
        const button = await test.driver.findElement(By.css(".js-show-drawer.btn-compose"));
        await button.click();
        await test.driver.wait(until.elementLocated(By.css(".js-show-drawer.btn-compose.is-hidden")), test.timeout);

        for (let i = 0; i < 5; i++) {
            console.log(`Test: Retweet (${i + 1}/5)`);

            // Open Retweet modal
            const retweet = await test.driver.findElement(By.css("a.tweet-action[rel=retweet]"));
            await retweet.click();

            // Wait until the dialog becomes available
            await test.driver.wait(until.elementLocated(By.css(".js-retweet-button")), test.timeout);

            for (let j = 0; j < 50; j++) {
                const accounts = await main.findElements(By.css("ul.js-account-selector li.js-account-item"));
                const target = accounts[Math.floor(Math.random() * accounts.length)];
                const id = await target.getAttribute("data-id");
                const item = await test.driver.findElement(By.css(`li.js-account-item[data-id="${id}"]`));
                await item.click();

                const current = await main.findElements(By.css("li.acc-selected"));
                assert(current.length <= 1);
            }

            // Close Retweet modal
            const closer = await test.driver.findElement(By.css(".js-dismiss"));
            await closer.click();
        }

        await test.driver.quit();
        console.log("Test: Done.");

        try {
            await fs.unlink(filename);
        } catch (e) {
            // No problem if fails
        }
    } catch (e) {
        console.error("Error: " + e);
        process.exit(1);
    }
})();
